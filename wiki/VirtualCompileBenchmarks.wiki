#summary Compile-benchmarks on several virtualization engines

= Introduction =

Often the slowest part of a test run is building the test source under a protected virtualization layer.  This benchmark configures and compiles about 3M of C source code on Debian/lenny.  This typically takes on the order of a minute and fits in a relatively small VM. Even on very underpowered host systems under heavy virtualization is likely to finish in an hour or so.  Single and multithreaded builds (make -j2) are recorded, and multiple host root filesystems and other options are compared as the particular VM allows.

= Details =

{{{
mkdir lenny-dir
debootstrap --arch=i386 --include=ssh,build-essential,libncurses-dev,wget --verbose lenny lenny-dir
dd if=/dev/zero bs=1M seek=1000 count=0 of=lenny.ext3
mkfs -t ext3 -F lenny.ext3
mkdir lenny-loopback
mount -o loop lenny.ext3 lenny-loopback
tar cf - -C lenny-dir . | tar xvf - -C lenny-loopback
umount lenny-loopback
}}}

{{{
aptitude install build-essential libncurses-dev wget
wget -O empire-4.3.10.tar.gz 'http://sourceforge.net/project/showfiles.php?group_id=24031&package_id=40131&release_id=537696'
tar zxvf empire-4.3.10.tar.gz
cd empire-4.3.10
./configure
time make
make clean
time make -j2
make clean
time make -j4
}}}

= Results =

||                      || Build || time(s) || || || || || ||
|| *Containers*         ||       || T60p^1^ || Atom^2^ || Quad^3^ ||
|| i386 chroot^a^       ||   -j1 ||  64s^*^ || 140s    || 39s     ||
||                      ||   -j2 ||     37s || 106s    || 20s     ||
||                      ||   -j4 ||         ||         || 13s     ||
|| i386 chroot loopback^b^ || -j1 || 54s^*^ ||         || 39s     ||
||                      ||   -j2 ||  36s    ||         || 21s     ||
||                      ||   -j4 ||         ||         || 13s     ||
|| x86_64 chroot^b^     || -j1   || _N/A_^@^ || 148s   || 40s     ||
||                      || -j2   || _N/A_^@^ || 112s   || 21s     ||
||                      || -j4   || _N/A_^@^ ||        || 14s     ||
||                      || -j8   || _N/A_^@^ ||        || 12s     ||
|| x86_64 chroot loopback || -j1 || _N/A_^@^ ||        || 40s     ||
||                        || -j2 || _N/A_^@^ ||        || 21s     ||
||                        || -j2 || _N/A_^@^ ||        || 14s     ||
|| i386 openvz          ||   -j1 || 53s || 149s ||
||                      ||   -j2 || 39s || 107s ||
||                      ||   -j4 || || 105s ||
|| x86_64 openvz        ||   -j1 || _N/A_^@^ || 148s   ||
||                      ||   -j2 || _N/A_^@^ || 114s   ||
|| i386 vserver         ||
|| x86_64 vserver       ||       || _N/A_^@^ ||
||                      || Build || time(s) || || || || || ||
|| *Paravirtualization* ||       || T60p^1^ || Atom^2^ || Quad^3^ ||
|| UML SKAS0            ||   -j1 ||  121s   ||         ||
||                      ||   -j2 ||  118s   ||
|| UML SKAS0 hostfs     ||   -j1 ||  142s   ||
|| UML SKAS0 hostfs     ||   -j2 ||  141s   ||
|| i386 xen^b^          ||   -j1 || hot^+^  ||         || 38s     ||
||                      ||   -j2 || hot^+^  ||         || 39s     ||
|| x86_64 xen^b^        ||   -j1 || _N/A_^@^ ||        || 38s     ||
||                      ||   -j2 || _N/A_^@^ ||        || 39s     ||
|| 4cpu x86_64 xen      ||   -j1 || _N/A_^@^ ||        || 40s     ||
||                      ||   -j2 || _N/A_^@^ ||        || 21s     ||
||                      ||   -j4 || _N/A_^@^ ||        || 14s     ||
|| i386 virtualbox      ||
|| x86_64 virtualbox    ||       || _N/A_^@^ ||
||                      || Build || time(s) || || || || || ||
|| *Full virtualiztion* ||       || T60p^1^ || Atom^2^ || Quad^3^ ||
|| i386 qemu^c^         ||   -j1 || 1260s   ||
||                      ||   -j2 || 1479s   ||
|| i386 qemu^c^ -smp 2  ||   -j2 || 1450s   ||
|| x86_64 qemu          ||   -j1 ||  ||  ||
|| i386 kqemu           ||   -j1 ||  ||
|| x86_64 kqemu         ||   -j2 || _N/A_^@^ ||
|| i386 kvm             ||   -j1 || 72s || _N/A_^&^ ||
||                      ||   -j2 || 75s || _N/A_^&^ ||
|| i386 kvm -smp 2      ||   -j2 || 40s || _N/A_^&^ ||
|| x86_64 kvm           ||   -j1 || _N/A_^@^ || _N/A_^&^ || ||
|| i386 xen hvm         ||
|| x86_64 xen hvm       ||       || _N/A_^@^ ||
|| VMWare               ||

^1^ - Lenovo Thinkpad T60p, 2G RAM, 2.17GHz Core Duo, 2.6.30 Debian/sid 2009-07.  host FS is on a LUKS encrypted partition

^2^ - Intel G945 1.6GHz, 2.6.26 Debian/lenny x86_64 host.  1G RAM. Host FS is unencrypted 1TB 7200rpm drive

^3^ - Dell 2950, 2x2 2.66 GHz Xeon, 4G RAM, 6x10K SCSI RAID5.

^a^ - `mkdir lenny ; debootstrap --arch=i386 _args_ lenny ; chroot lenny /bin/bash`

^b^ - Debian/lenny Xen 3.2 per http://www.howtoforge.com/virtualization-with-xen-on-debian-lenny-amd64

^c^ - `dd if=/dev/zero bs=1M seek=1000 count=0 of=lenny.ext3 ; mkfs -t ext3 -F lenny.ext3 ; mkdir lenny ; mount -o loop lenny.ext3 lenny`

^d^ - `qemu -m 256M -hda lenny.ext3 -net nic -net tap,ifname=tap0,script=no -kernel /boot/vmlinuz-2.6.30-1-686 -initrd /boot/initrd.img-2.6.30-1-686 -append root=/dev/hda`

^*^ - very unexpected that host filesystem is typically slower than loopback

^&^ - No harware virtualization (vmx/svm) CPU feature flag.

^@^ - No 64bit (lm) CPU feature flag.

^+^ - Xen runs CPUs at full clock rate, and caused multiple thermal shutdowns before file-backed VMs could be debugged on this platform. No performance numbers are available pending cooling improvements.  Running Xen on a laptop is a bad idea on power and thermal considerations.

== Warnings ==

  Verify that the local clock is accurate.  Some run slow under some virtualization engines. QEMU and UML are particularly susceptible to this.  time an ssh session into the machine that sleeps for a known amount of time.

= Preliminary results =

  1 Don't use Xen on laptops due to thermal and power considerations.

  2 Use containers if possible (eg. OpenVZ).

  3 Use UML if no kernel mods are possible and architecture is compatible.

  4 Qemu always works on everything, and is a good place to start a design.

  5 KVM is fast (90%+ bare metal) and drop-in Qemu compatible.