#summary Compile-benchmarks on several virtualization engines

= Introduction =

Often the slowest part of a test run is building the test source under a protected virtualization layer.  This benchmark is to configure and compile about 14M of C source code on Debian/lenny i386.  This typically takes on the order of a minute and fits in a relatively small VM, and even on very underpowered host systems under heavy virtualization is likely to finish in an hour or so.  Single and multithreaded builds (make -j2) are recorded, and multiple host root filesystem and other options are compared as the particular VM allows.

= Details =

{{{
mkdir lenny-dir
debootstrap --arch=i386 --include=ssh,build-essential,libncurses-dev,wget --verbose lenny lenny-dir
dd if=/dev/zero bs=1M seek=1000 count=0 of=lenny.ext3
mkfs -t ext3 -F lenny.ext3
mkdir lenny-loopback
mount -o loop lenny.ext3 lenny-loopback
tar cf - -C lenny-dir . | tar xvf - -C lenny-loopback
umount lenny-loopback
}}}

{{{
aptitude install build-essential libncurses-dev wget
wget -O empire-4.3.10.tar.gz 'http://sourceforge.net/project/showfiles.php?group_id=24031&package_id=40131&release_id=537696'
tar zxvf empire-4.3.10.tar.gz
cd empire-4.3.10
./configure
time make
make clean
time make -j2
make clean
time make -j4
}}}

= Results =

|| Virtualization       || Build || Host time (s) || || || || ||
||                      ||       || T60p ^1^ || Atom ^2^ || Quad ^3^ ||
|| i386 chroot^a^       ||   -j1 ||  64s ^A^ || ||
||                      ||   -j2 ||      37s || ||
|| i386 chroot loopback^b^ ||   -j1 ||  54s ^A^ ||          ||
||                      ||   -j2 ||  36s     ||          ||
|| x86_64 chroot^b^     || -j1   || _N/A_    || ||
|| UML SKAS0            ||   -j1 ||  121s    || ||
||                      ||   -j2 ||  118s    ||
|| UML SKAS0 hostfs     ||   -j1 ||  142s    ||
|| UML SKAS0 hostfs     ||   -j2 ||  141s    ||
|| i386 qemu ^c^        ||   -j1 || 1260s    ||
||                      ||   -j2 || 1479s    ||
|| i386 qemu ^c^ -smp 2 ||   -j2 || 1450s    ||
|| x86_64 qemu          ||   -j1 ||  ||  ||
|| i386 qemu ^c^ -smp 4 ||   -j4 || || || ||
|| i386 kvm             ||   -j1 || || _N/A_ ||
||                      ||   -j2 || || _N/A_ ||
|| x86_64 kvm           ||   -j1 || _N/A_ || _N/A_ || ||
|| i386 openvz          ||   -j1 || || 149s ||
||                      ||   -j2 || || 107s ||
||                      ||   -j4 || || 
|| x86_64 openvz        ||   -j1 || _N/A_ || ||
||                      ||   -j2 || _N/A_ || ||
|| xen                  ||   -j1 || ||
||                      ||   -j2 || ||

^1^ - Lenovo Thinkpad T60p, 2G RAM, 2.17GHz Core Duo, 2.6.30 Debian/sid 2009-07.  host FS is on a LUKS encrypted partition

^2^ - Intel G945 1.6GHz, 2.6.26 Debian/lenny x86_64 host.  1G RAM. Host FS is unencrypted 1TB 7200rpm drive

^3^ - HP T4300 Core2 Quad 3.4 GHz, Ubuntu/hardy 2.6.24 x86_64 host.  8G RAM.

^a^ - `mkdir lenny ; debootstrap --arch=i386 _args_ lenny ; chroot lenny /bin/bash`

^c^ - `dd if=/dev/zero bs=1M seek=1000 count=0 of=lenny.ext3 ; mkfs -t ext3 -F lenny.ext3 ; mkdir lenny ; mount -o loop lenny.ext3 lenny`

^d^ - `qemu -m 256M -hda lenny.ext3 -net nic -net tap,ifname=tap0,script=no -kernel /boot/vmlinuz-2.6.30-1-686 -initrd /boot/initrd.img-2.6.30-1-686 -append root=/dev/hda`

^A^ - very unexpected that host filesystem is typically slower than loopback

^B^ - not actually chrooted, build timed in native Debian/lenny OS.